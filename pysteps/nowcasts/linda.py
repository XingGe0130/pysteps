"""
pysteps.nowcasts.linda
======================

This module implements the Lagrangian INtegro-Difference equation model with
Autoregression (LINDA). The model combines elements from extrapolation,
S-PROG, STEPS and ANVIL, cell tracking and integro-difference equation (IDE)
models with the aim of producing improved nowcasts for convective events. It
consists of the following components:

1. feature detection to identify rain cells
2. advection-based nowcast
3. autoregressive integrated (ARI) process to predict growth and decay
4. convolution to account for loss of predictability
5. stochastic perturbations to simulate forecast errors

Focusing on convective cells, LINDA uses a sparse representation of the input
data. The cells are identified using a blob detection method :cite:`?`. The
advection field is determined using based on the detected blobs, and the
remaining components of the model are applied in the Lagrangian coordinates.
Using the ARI process is adapted from ANVIL :cite:`PCLH2020`, and the
convolution is adapted from the integro-difference equation (IDE)
methodology developed in :cite:`?`. Combination of these two approaches
essentially replaces the cascade decomposition used in S-PROG and STEPS.
Using the convolution has several advantages such as the ability to handle
anisotropic structure, domain boundaries and missing data.

All components of the model are localized at the identified rain cells. The
advection field is determined using the sparse Lucas-Kanade method and
interpolated to cover the whole domain. The convolution is implemented by using
a spatially variable kernel that can describe anisotropic structure. Based on
the marginal distribution and covariance structure of forecast errors, localized
perturbations are generated by adapting the SSFT methodology developed in
:cite:`NBSG2017`.

.. autosummary::
    :toctree: ../generated/

    forecast
"""


def forecast(
    precip_fields_fields,
    advection_field,
    ari_order=1,
    add_perturbations=True,
    n_ens_members=24,
):
    """Generate a nowcast ensemble by using the Lagrangian INtegro-Difference
    equation model with Autoregression (LINDA).

    Parameters
    ----------
    precip_fields : array_like
        Array of shape (ari_order+2,m,n) containing the input precipitation
        fields ordered by timestamp from oldest to newest. The time steps
        between the inputs are assumed to be regular.
    advection_field : array_like
        Array of shape (2,m,n) containing the x- and y-components of the
        advection field. The velocities are assumed to represent one time step
        between the inputs.
    ari_order : int
        Order of the ARI(p,1) model.
    add_perturbations : bool
        Set to False to disable perturbations and generate a deterministic
        nowcast.
    n_ens_members : int
        Number of ensemble members.

    Returns
    -------
    out : numpy.ndarray
        A four-dimensional array of shape (n_ens_members,n_timesteps,m,n)
        containing a time series of forecast precipitation fields for each
        ensemble member. The time series starts from t0+timestep, where
        timestep is taken from the input fields.
    """
    pass
